<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Vue3 + PrimeVue Sample</title>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=0.9, maximum-scale=1.8, minimum-scale=0.9, user-scalable=yes">

    <link href="css/primeicons.css" rel="stylesheet"/>
    <link href="/css/swiper-bundle.min.css" rel="stylesheet"/>
    <link href="css/custom.css" rel="stylesheet"/>
    <link href="css/overlayscrollbars.min.css" rel="stylesheet"/>

    <script src="js/vue.global.js"></script>
    <script src="js/primevue.min.js"></script>
    <script src="js/aura.js"></script>
    <script src="js/tailwindcss.js"></script>
    <script src="/js/swiper-bundle.min.js"></script>
    <script src="/js/overlayscrollbars.browser.es6.min.js"></script>

</head>
<body class="bg-gray-100">
<div id="app">
    <overlay-scrollbars style="max-height: 100vh;">
        <div class="mx-auto p-6 space-y-6" style="max-width: 1035px;">
            <h1 class="text-2xl font-bold text-center">Vue3 + PrimeVue Sample <span class="text-cyan-600">(DataTable)</span></h1>

            <p-toolbar class="justify-between">
                <template #center>
                    <div class="flex flex-wrap gap-2">
                        <a href="sample1.html">
                            <p-button label="Form" size="small" variant="text" severity="primary"/>
                        </a>
                        <a href="sample2.html">
                            <p-button label="Tabs/Swiper/Drawer" size="small" variant="text" severity="secondary"/>
                        </a>
                        <a href="sample8.html">
                            <p-button label="Accordian" size="small" variant="text" severity="success"/>
                        </a>
                        <a href="sample3.html">
                            <p-button label="DataTable" size="small" variant="text" severity="info"/>
                        </a>
                        <a href="sample7.html">
                            <p-button label="Overlays" size="small" variant="text" severity="warn"/>
                        </a>
                        <a href="sample5.html">
                            <p-button label="Button" size="small" variant="text" severity="help"/>
                        </a>
                        <a href="sample4.html">
                            <p-button label="Tree/PickList" size="small" variant="text" severity="danger"/>
                        </a>
                        <a href="sample6.html">
                            <p-button label="Tag/Spinner/Toast" size="small" variant="text" severity="contrast"/>
                        </a>
                    </div>
                </template>
            </p-toolbar>

            <section class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">기본</h2>
                <p-datatable
                        :value="products"
                        :removable-sort="true"
                        scroll-height="flex"
                >
                    <p-column v-for="col in columns"
                              :key="col.field"
                              :field="col.field"
                              :header="col.header"
                              :sortable="col.sortable !== false"
                              :removable-sort="col.removableSort !== false"
                              :style="{ width: col.width, textAlign: col.align }"></p-column>
                </p-datatable>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Row Selection (Single, Multiple)</h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Single Selection -->
                    <div>
                        <h3 class="font-medium mb-2">Single</h3>
                        <p-datatable
                                :value="products"
                                data-key="code"
                                :removable-sort="true"
                                selection-mode="single"
                                v-model:selection="selectedProduct"
                                :meta-key-selection="false"
                        >
                            <p-column v-for="col in columns"
                                      :key="col.field" :field="col.field"
                                      :header="col.header"
                                      :sortable="col.sortable !== false"
                                      :removable-sort="col.removableSort !== false"
                                      :style="{ width: col.width, textAlign: col.align }"></p-column>
                        </p-datatable>
                        <div class="text-sm text-gray-600 mt-2">선택:
                            {{ selectedProduct ? selectedProduct.name + ' (' + selectedProduct.code + ')' : '없음' }}
                        </div>
                    </div>

                    <!-- Multiple Selection -->
                    <div>
                        <h3 class="font-medium mb-2">Multiple</h3>
                        <p-datatable
                                :value="products"
                                data-key="code"
                                selection-mode="multiple"
                                v-model:selection="selectedProducts"
                                :meta-key-selection="false"
                        >
                            <p-column selection-mode="multiple"
                                      header-style="width:3rem"
                                      frozen align-frozen="left"
                                      :column-resizable-disabled="true"></p-column>
                            <p-column v-for="col in columns"
                                      :key="col.field"
                                      :field="col.field"
                                      :header="col.header"
                                      :sortable="col.sortable !== false"
                                      :removable-sort="col.removableSort !== false"
                                      :style="{ width: col.width, textAlign: col.align }"></p-column>
                        </p-datatable>
                        <div class="text-sm text-gray-600 mt-2">선택 개수: {{ selectedProducts.length }}개</div>
                    </div>
                </div>
            </section>

            <section class="bg-white p-4 rounded shadow">
                <h2 class="text-lg font-semibold mb-2">Row 선택 이벤트</h2>
                <p class="text-sm text-gray-600 mb-2">single 선택 모드에서 row를 선택하면 해당 row의 내용을 alert로 표시합니다.</p>
                <p-datatable
                        :value="products"
                        data-key="code"
                        selection-mode="single"
                        v-model:selection="selectedProductEvent"
                        :meta-key-selection="false"
                        @row-select="onRowSelect"
                >
                    <p-column v-for="col in columns"
                              :key="col.field"
                              :field="col.field"
                              :header="col.header"
                              :sortable="col.sortable !== false"
                              :removable-sort="col.removableSort !== false"
                              :style="{ width: col.width, textAlign: col.align }"></p-column>
                </p-datatable>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">높이 설정</h2>
                <p class="text-sm text-gray-600">두 가지 방식으로 그리드 높이를 설정합니다.</p>

                <!-- Case 1: 컨테이너 높이만큼 자동 설정 (flex 높이) -->
                <div>
                    <h3 class="font-medium mb-2">Case 1: 컨테이너 높이 자동(Flex)</h3>
                    <p class="text-xs text-gray-500 mb-2">컨테이너에 고정 높이를 주고, DataTable은 scrollable + scrollHeight="flex"로
                        컨테이너를 가득 채웁니다.</p>
                    <div class="border rounded p-2 h-64">
                        <p-datatable
                                :value="products"
                                scroll-height="flex"
                        >
                            <p-column v-for="col in columns"
                                      :key="col.field"
                                      :field="col.field"
                                      :header="col.header"
                                      :sortable="col.sortable !== false"
                                      :removable-sort="col.removableSort !== false"
                                      :style="{ width: col.width, textAlign: col.align }"></p-column>
                        </p-datatable>
                    </div>
                </div>

                <!-- Case 2: 고정 높이 -->
                <div>
                    <h3 class="font-medium mb-2">Case 2: 고정 높이</h3>
                    <p class="text-xs text-gray-500 mb-2">DataTable에 고정 높이를 지정하여 본문을 내부 스크롤합니다.</p>
                    <p-datatable
                            :value="products"
                            scroll-height="300px"
                    >
                        <p-column v-for="col in columns"
                                  :key="col.field"
                                  :field="col.field"
                                  :header="col.header"
                                  :sortable="col.sortable !== false"
                                  :removable-sort="col.removableSort !== false"
                                  :style="{ width: col.width, textAlign: col.align }"></p-column>
                    </p-datatable>
                </div>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Row Expansion(서브 그리드)</h2>
                <p class="text-sm text-gray-600">행을 펼쳐서 상세 정보 또는 서브 그리드를 표시하는 예제입니다.</p>

                <p-datatable
                        class="dt-exp-anim dt-exp-wide"
                        data-key="code"
                        :value="productsWithDetails"
                        v-model:expanded-rows="expandedRows"
                        scroll-height="flex"
                >
                    <!-- body-class=expander-cell: 디렉티브가 이 셀 전체를 토글 영역으로 만듭니다 -->
                    <p-column expander body-class="expander-cell" style="width:3rem" frozen align-frozen="left" :column-resizable-disabled="true"></p-column>
                    <p-column field="code" header="Code" style="min-width:10rem"></p-column>
                    <p-column field="name" header="Name" style="min-width:14rem"></p-column>
                    <p-column field="category" header="Category" style="min-width:12rem"></p-column>
                    <p-column field="quantity" header="Quantity" style="min-width:10rem; text-align:right"></p-column>
                    <p-column field="price" header="Price" style="min-width:10rem; text-align:right"></p-column>
                    <p-column header="Brand" style="min-width:12rem">
                        <template #body="{ data }">{{ data.brand || 'Prime' }}</template>
                    </p-column>
                    <p-column header="Supplier" style="min-width:14rem">
                        <template #body="{ data }">{{ data.supplier || 'Acme Co.' }}</template>
                    </p-column>
                    <p-column header="Status" style="min-width:10rem">
                        <template #body="{ data }">{{ (data.quantity > 0) ? 'In Stock' : 'Out of Stock' }}</template>
                    </p-column>
                    <p-column header="SKU" style="min-width:12rem">
                        <template #body="{ data }">{{ data.code + '-SKU' }}</template>
                    </p-column>
                    <p-column header="Rating" style="min-width:10rem; text-align:right">
                        <template #body="{ data }">{{ (data.price % 5) + 1 }}★</template>
                    </p-column>

                    <template #expansion="{ data }">
                        <div :key="data.code" class="p-3">
                            <div class="font-medium mb-2">{{ data.name }} 상세</div>
                            <div v-if="data.items && data.items.length">
                                <p-datatable
                                        :value="data.items"
                                        size="small"
                                        :table-style="{ minWidth: '50rem' }"
                                        style="display:inline-block"
                                >
                                    <p-column field="id" header="#"></p-column>
                                    <p-column field="desc" header="Item"></p-column>
                                    <p-column field="qty" header="Qty"></p-column>
                                    <p-column field="amount" header="Amount"></p-column>
                                </p-datatable>
                            </div>
                            <div v-else class="text-sm text-gray-500">세부 항목이 없습니다.</div>
                        </div>
                    </template>
                </p-datatable>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Frozen Rows</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Virtual Scroll</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Column Group</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Edit Cell</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Add & Delete Row</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>

            <section class="bg-white p-4 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-2">Excel Download (Export)</h2>
                <p class="text-sm text-gray-600">.</p>
            </section>
        </div>
    </overlay-scrollbars>
</div>

<script>
  const {h, createApp, ref, withDirectives} = Vue;

  const app = createApp({
    setup() {
      const products = ref([
        {code: 'P100', name: 'Bamboo Watch', category: 'Accessories', quantity: 24, price: 65},
        {code: 'P101', name: 'Black Watch', category: 'Accessories', quantity: 61, price: 72},
        {code: 'P102', name: 'Blue Band', category: 'Fitness', quantity: 2, price: 29},
        {code: 'P103', name: 'Game Controller', category: 'Electronics', quantity: 99, price: 99},
        {code: 'P104', name: 'Gaming Set', category: 'Electronics', quantity: 63, price: 299},
        {code: 'P105', name: 'Green Earbuds', category: 'Audio', quantity: 5, price: 49},
        {code: 'P106', name: 'USB Cable', category: 'Accessories', quantity: 150, price: 9},
      ]);

      const productsWithDetails = ref([
        {
          code: 'P100',
          name: 'Bamboo Watch',
          category: 'Accessories',
          quantity: 24,
          price: 65,
          items: [
            {id: 1, desc: 'Strap', qty: 1, amount: 15},
            {id: 2, desc: 'Gift Box', qty: 1, amount: 5}
          ]
        },
        {
          code: 'P101',
          name: 'Black Watch',
          category: 'Accessories',
          quantity: 61,
          price: 72,
          items: [
            {id: 1, desc: 'Warranty(2y)', qty: 1, amount: 0}
          ]
        },
        {
          code: 'P102',
          name: 'Blue Band',
          category: 'Fitness',
          quantity: 2,
          price: 29,
          items: [

          ]
        },
        {
          code: 'P103',
          name: 'Game Controller',
          category: 'Electronics',
          quantity: 99,
          price: 99,
          items: [
            {id: 1, desc: 'USB-C Cable', qty: 1, amount: 9},
            {id: 2, desc: 'Carry Pouch', qty: 1, amount: 12}
          ]
        },
        {
          code: 'P104',
          name: 'Gaming Set',
          category: 'Electronics',
          quantity: 63,
          price: 299,
          items: [
            {id: 1, desc: 'Keyboard', qty: 1, amount: 120},
            {id: 2, desc: 'Mouse', qty: 1, amount: 50},
            {id: 3, desc: 'Headset', qty: 1, amount: 80}
          ]
        },
        {
          code: 'P105',
          name: 'Green Earbuds',
          category: 'Audio',
          quantity: 5,
          price: 49,
          items: [
            {id: 1, desc: 'Extra Tips', qty: 3, amount: 6}
          ]
        },
        {
          code: 'P106',
          name: 'USB Cable',
          category: 'Accessories',
          quantity: 150,
          price: 9,
          items: [
            {id: 1, desc: 'Velcro Tie', qty: 1, amount: 1}
          ]
        }
      ]);

      const columns = ref([
        {field: 'code', header: 'Code', width: '10rem'},
        {field: 'name', header: 'Name', width: '14rem'},
        {field: 'category', header: 'Category', width: '12rem'},
        {field: 'quantity', header: 'Quantity', width: '10rem', align: 'right'},
        {field: 'price', header: 'Price', width: '10rem', align: 'right'}
      ]);

      const selectedProduct = ref(null);
      const selectedProducts = ref([]);
      const selectedProductEvent = ref(null);
      const expandedRows = ref({});

      const onRowSelect = (event) => {
        try {
          const row = event?.data || selectedProductEvent?.value || null;
          if (!row) {
            alert('선택된 행이 없습니다.');
            return;
          }
          const msg = [
            `Code: ${row.code}`,
            `Name: ${row.name}`,
            `Category: ${row.category}`,
            `Quantity: ${row.quantity}`,
            `Price: ${row.price}`
          ].join('\n');
          alert(msg);
        } catch (e) {
          alert('행 정보를 표시하는 중 오류가 발생했습니다.');
        }
      };

      return {
        products,
        productsWithDetails,
        columns,
        selectedProduct,
        selectedProducts,
        selectedProductEvent,
        expandedRows,
        onRowSelect
      };
    },
  });

  /* ★★★ DataTable Row Expansion: expander 셀(td) 전체 클릭/키보드로 토글하는 디렉티브 ★★★
     사용법(필수 2가지):
     1) 테이블에 범위 클래스 추가: class="dt-exp-wide"
     2) 확장 컬럼에 바디 클래스 부여: <p-column expander body-class="expander-cell" ...>
     적용 결과: td.expander-cell 어디를 클릭/Enter/Space 해도 내부의 실제 토글 버튼
     (.p-datatable-row-toggle-button)을 클릭해 Row Expansion을 열고/닫습니다.
     접근성: 실제 버튼을 대리 클릭하므로 aria-expanded, 포커스, 키보드 내비게이션은 PrimeVue 기본을 유지합니다.
  */
  app.directive('expand-td-toggle', {
    mounted(el) {
      const isInteractive = (t) => !!t.closest('a,button,input,select,textarea,label,[role="button"],[contenteditable="true"]');
      const isRealToggleBtn = (t) => !!t.closest('.p-datatable-row-toggle-button');
      const inScopeTable = (t) => !!t.closest('.dt-exp-wide');

      const click = (e) => {
        if (!inScopeTable(e.target)) return;
        if (isRealToggleBtn(e.target)) return; // 원래 버튼 클릭은 패스
        if (isInteractive(e.target)) return;   // 다른 인터랙티브 요소 무시

        const cell = e.target.closest('td.expander-cell');
        if (!cell || !el.contains(cell)) return;
        const btn = cell.querySelector('.p-datatable-row-toggle-button');
        if (btn) btn.click();
      };

      const keydown = (e) => {
        if (!(e.key === 'Enter' || e.key === ' ' || e.code === 'Space')) return;
        if (!inScopeTable(e.target)) return;
        const cell = e.target.closest('td.expander-cell');
        if (!cell || !el.contains(cell)) return;
        const btn = cell.querySelector('.p-datatable-row-toggle-button');
        if (!btn) return;
        e.preventDefault();
        btn.click();
      };

      el.__expWideHandlers = { click, keydown };
      // 테이블 내부 위임: 버블 단계에서 처리
      el.addEventListener('click', click);
      el.addEventListener('keydown', keydown);
    },
    unmounted(el) {
      const h = el.__expWideHandlers; if (!h) return;
      el.removeEventListener('click', h.click);
      el.removeEventListener('keydown', h.keydown);
      delete el.__expWideHandlers;
    }
  });

  /* ★★★ DataTable 내부 스크롤 영역에만 OS 적용하는 디렉티브 ★★★ */
  app.directive('os-datatable', {
    mounted(el, binding) {
      const g = window.OverlayScrollbarsGlobal;
      if (!g || !g.OverlayScrollbars) return;

      const getOpts = () => {
        const v = binding?.value || {};
        return {scrollbars: {autoHide: v.autoHide ?? 'never'}};
      };

      const state = {observer: null, bodies: new Set(), options: getOpts()};

      const apply = () => {
        // PrimeVue v4/v5: .p-datatable-table-container 가 스크롤 컨테이너
        const bodies = el.querySelectorAll('.p-datatable-table-container');
        bodies.forEach((body) => {
          if (!body.__osInstance) {
            body.__osInstance = g.OverlayScrollbars(body, state.options);
            state.bodies.add(body);
          } else {
            try {
              body.__osInstance.options(state.options);
            } catch (_) {
            }
          }
        });
        // 제거된 컨테이너 정리
        [...state.bodies].forEach((body) => {
          if (!el.contains(body)) {
            try {
              body.__osInstance?.destroy();
            } catch (_) {
            }
            state.bodies.delete(body);
          }
        });
      };

      apply();
      // DataTable 렌더/확장/스크롤영역 생성 변화 감지
      const mo = new MutationObserver(() => apply());
      mo.observe(el, {childList: true, subtree: true});
      state.observer = mo;
      el.__osDtState = state;
    },
    updated(el, binding) {
      const state = el.__osDtState;
      if (!state) return;
      state.options = {scrollbars: {autoHide: (binding?.value?.autoHide ?? 'never')}};
      // 옵션 갱신
      state.bodies.forEach((body) => {
        try {
          body.__osInstance?.options(state.options);
        } catch (_) {
        }
      });
    },
    unmounted(el) {
      const state = el.__osDtState;
      if (!state) return;
      state.observer?.disconnect();
      state.bodies.forEach((body) => {
        try {
          body.__osInstance?.destroy();
        } catch (_) {
        }
      });
      el.__osDtState = null;
    }
  });

  // PrimeVue 설정
  app.use(PrimeVue.Config, {theme: {preset: PrimeUIX.Themes.Aura}});
  const {Toolbar, Button, DataTable, Column} = PrimeVue;

  app.component('p-datatable', {
    props: {scrollHeight: {type: String, default: ''}},
    setup(props, {attrs, slots}) {
      return () => withDirectives(
        h(DataTable, {
          showGridlines: true,
          stripedRows: true,
          rowHover: true,
          scrollable: true,
          removableSort: true,
          resizableColumns: true,
          columnResizeMode: 'expand',
          scrollHeight: props.scrollHeight,
          ...attrs
        }, slots),
        [
          [app._context.directives['os-datatable'], {mode: 'auto', autoHide: 'never', axis: 'both'}],
          [app._context.directives['expand-td-toggle']]
        ]
      );
    }
  });

  app.component('p-column', Column);
  app.component('p-toolbar', Toolbar);
  app.component('p-button', Button);

  // 페이지 전체 래퍼용 컴포넌트 (그대로 유지, autoHide만 'never'로)
  app.component('overlay-scrollbars', {
    props: ['style', 'class'],
    mounted() {
      // ★ 항상 보이기
      window.OverlayScrollbarsGlobal.OverlayScrollbars(this.$el, {scrollbars: {autoHide: 'never'}});
    },
    render() {
      return Vue.h('div', {style: this.style, class: this.$props.class}, this.$slots.default());
    }
  });

  app.mount('#app');
</script>
</body>
</html>
